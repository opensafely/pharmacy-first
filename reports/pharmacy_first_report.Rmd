---
title: "Pharmacy First"
output:
  html_document:
    toc: true
    toc_depth: 4
  pdf_document: default
date: "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: references.bib
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(here)
library(readr)
library(gt)
```

```{r load-data, message=FALSE, warning=FALSE}
# Load plotting function
source(here::here("lib", "functions", "function_tidy_measures.R"))
source(here::here("lib", "functions", "function_plot_measures.R"))

# Load data based on environment
if (Sys.getenv("OPENSAFELY_BACKEND") != "") {
  # Load data from generate_pf_measures action
  df_measures <- readr::read_csv(
    here::here("output", "measures", "pf_codes_conditions_measures.csv")
  )
} else {
  # Load data from released_output directory
  df_measures <- readr::read_csv(
    here::here("released_output", "measures", "pf_codes_conditions_measures.csv")
  )
}

# Load validation data (NHS BSA)
df_bsa_validation <- read_csv(here("lib", "validation", "data", "pf_consultation_validation_data.csv"))

df_descriptive_stats <- read_csv(here("output", "measures", "pf_descriptive_stats_measures.csv"))

# Define dictionaries with tidy names and mappings for measures
pf_measures_name_dict <- list(
  consultation_service = "Consultation Service",
  pharmacy_first_service = "Pharmacy First Consultation",
  combined_pf_service = "Pharmacy First Consultations (Combined)",
  acute_otitis_media = "Acute Otitis Media",
  herpes_zoster = "Herpes Zoster",
  acute_sinusitis = "Acute Sinusitis",
  impetigo = "Impetigo",
  infected_insect_bite = "Infected Insect Bite",
  acute_pharyngitis = "Acute Pharyngitis",
  uncomplicated_urinary_tract_infection = "UTI"
)

pf_measures_name_mapping <- list(
  consultation_service = "clinical_service",
  pharmacy_first_service = "clinical_service",
  combined_pf_service = "pharmacy_first_services",
  acute_otitis_media = "clinical_condition",
  herpes_zoster = "clinical_condition",
  acute_sinusitis = "clinical_condition",
  impetigo = "clinical_condition",
  infected_insect_bite = "clinical_condition",
  acute_pharyngitis = "clinical_condition",
  uncomplicated_urinary_tract_infection = "clinical_condition"
)

pf_measures_groupby_dict <- list(
  age_band = "Age band",
  sex = "Sex",
  imd = "IMD",
  region = "Region",
  ethnicity = "Ethnicity"
)

df_measures <- tidy_measures(
  data = df_measures,
  pf_measures_name_dict = pf_measures_name_dict,
  pf_measures_name_mapping = pf_measures_name_mapping,
  pf_measures_groupby_dict = pf_measures_groupby_dict
)

df_measures$ethnicity <- factor(
  df_measures$ethnicity,
  levels = c(
    "White", "Mixed", "Asian or Asian British",
    "Black or Black British", "Chinese or Other Ethnic Groups",
    "Missing"
  ),
  ordered = TRUE
)

df_measures$age_band <- factor(
  df_measures$age_band,
  levels = c(
    "0-19", "20-39", "40-59",
    "60-79", "80+",
    "Missing"
  ),
  ordered = TRUE
)

df_measures$region <- factor(
  df_measures$region,
  levels = c(
    "East", "East Midlands", "London",
    "North East", "North West", "South East",
    "South West", "West Midlands", "Yorkshire and The Humber",
    "Missing"
  ),
  ordered = TRUE
)

df_measures <- df_measures %>%
  mutate(sex = factor(sex, levels = c("female", "male"), labels = c("Female", "Male")))

df_measures$age_band[is.na(df_measures$age_band)] <- "Missing"  

gradient_palette <- c("#001F4D", "#0056B3", "#007BFF", "#66B3E2", "#A4D8E1", "grey")
region_palette <- c("red", "navy", "#018701", "#ffa600ca", "purple", "brown", "#f4a5b2", "cyan", "green", "grey")
ethnicity_palette <- c("#42db0188", "#0056B3", "#ff0000c2", "#a52a2a5a", "purple", "grey")
sex_palette <- c("red", "blue")
```

# Background

Add background here.

# Methods

## Data source

Primary care records managed by the GP software provider TPP were accessed through OpenSAFELY (https://opensafely.org).
OpenSAFELY-TPP covers approximately 40% of the population of England, for a detailed description of the representativeness see @Andrews2022.

Between 1st November 2023 and 1st September 2024, we identified individuals aged between 0 and 120 years who were registered at a TPP practice each month across the study period. 
From this cohort, we counted the number of patients with at least one SNOMED CT code indicating a consultation using the Pharmacy First Service. 
Patients with more than one instance of the same clinical code within a month were counted only once.

Our study relied on the correct entry of relevant Pharmacy First codes in patients' GP records. 
The Pharmacy First service uses [GP Connect - Update Record](https://digital.nhs.uk/services/gp-connect/gp-connect-in-your-organisation/gp-connect-update-record) to update a patient's GP record with consultation information from community pharmacies. 
Following the launch of the Pharmacy First service, there has been a [Gradual roll-out of GP Connect - Update Record](https://cpe.org.uk/our-news/gp-connect-update-record-rollout-and-flow-of-information/) across approved community pharmacy IT system suppliers.

### Population

The eligible patient population for each clinical condition associated with Pharmacy First is detailed in the table below.
Currently, we have not yet applied any of the inclusion or exlusion citeria to restrict the population used in this report.
This will initially help us to understand the underlying data.

```{r echo=FALSE, message=FALSE}
# Create clinical pathways dataframe
clinical_pathways_table <- data.frame(
  Condition = c(
    "Uncomplicated Urinary Tract Infection",
    "Shingles",
    "Impetigo",
    "Infected Insect Bites",
    "Acute Sore Throat",
    "Acute Sinusitis",
    "Acute Otitis Media"
  ),
  Age = c(
    "16 to 64 years",
    "18 years and over",
    "1 year and over",
    "1 year and over",
    "5 years and over",
    "12 years and over",
    "1 to 17 years"
  ),
  Sex = c(
    "Female",
    "Any",
    "Any",
    "Any",
    "Any",
    "Any",
    "Any"
  ),
  Exclusions = c(
    "Pregnant individuals, urinary catheter, recurrent UTI (2 episodes in last 6 months, or 3 episodes in last 12 months)",
    "Pregnant individuals",
    "Bullous impetigo, recurrent impetigo (2 or more episodes in the same year), pregnant individuals under 16 years",
    "Pregnant individuals under 16 years",
    "Pregnant individuals under 16 years",
    "Immunosuppressed individuals, chronic sinusitis (symptoms lasting more than 12 weeks), pregnant individuals under 16 years",
    "Recurrent acute otitis media (3 or more episodes in 6 months or four or more episodes in 12 months), pregnant individuals under 16 years"
  )
)

# Create clinical pathways table
clinical_pathways_table %>%
  gt() %>%
  tab_header(
    title = "Table 1. Pharmacy First population criteria"
    # subtitle = "Inclusion and exclusion criteria for clinical pathway/conditions"
  ) %>%
  cols_label(
    Condition = "Condition",
    Age = "Age Range",
    Sex = "Sex",
    Exclusions = "Exclusions"
  ) %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large",
    heading.subtitle.font.size = "small"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  )

```

### Codelists

We used the following codelists to identify Pharmacy First consultations, conditions, and demographic breakdowns.

#### Pharmacy First consultation codes

The following two SNOMED codes were used to identify Pharmacy First consultations.
For clarity, we combined these codes for the presentation of the results.

```{r echo=FALSE}

# Create pharmacy first service codes dataframe
pharmacy_first_table <- data.frame(
  codelist = c(
    "Community Pharmacist (CP) Consultation Service for minor illness (procedure)",
    "Pharmacy First service (qualifier value)"
  ),
  code = c(
    "1577041000000109",
    "983341000000102"
  )
)

# Create pharmacy first service codes table
pharmacy_first_table %>%
  gt() %>%
  tab_header(
    title = "Table 2. Pharmacy First consultation codes",
    # subtitle = "Codelist descriptions and their respective SNOMED codes"
  ) %>%
  cols_label(
    codelist = md("**Codelist Description**"),
    code = md("**SNOMED Code**")
  ) %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large",
    heading.subtitle.font.size = "small"
  )
```

#### Pharmacy First condition codes

To categorise clinical events related to Pharmacy First services used the Pharmacy First [Clinical Pathways Codelist](https://www.opencodelists.org/codelist/opensafely/pharmacy-first-clinical-pathway-conditions/7ec97762/#full-list).

```{r echo=FALSE, message=FALSE}

clinical_codes_table <- data.frame(
  condition = c(
    "Acute otitis media",
    "Herpes zoster",
    "Acute sinusitis",
    "Impetigo",
    "Infected insect bite",
    "Acute pharyngitis",
    "Uncomplicated urinary tract infection"
  ),
  code = c(
    "3110003",
    "4740000",
    "15805002",
    "48277006",
    "262550002",
    "363746003",
    "1090711000000102"
  )
)

clinical_codes_table %>%
  gt() %>%
  tab_header(
    title = "Table 3. Pharmacy First condition codes"
    # subtitle = "Clinical conditions and their corresponding SNOMED codes"
  ) %>%
  cols_label(
    condition = md("**Clinical Condition**"),
    code = md("**SNOMED Code**")
  ) %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large",
    heading.subtitle.font.size = "small"
  )
```

#### Pregnancy Codelist

The [Pregnancy Codelist](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/preg_cod/20200812/#full-list) was used to identify patients who were pregnant during each month.

#### Ethnicity Codelist

We used the [Ethnicity Codelist](https://www.opencodelists.org/codelist/opensafely/ethnicity-snomed-0removed/2e641f61/) identify ethnicity in Electronic Health Records.
To ensure comprehensive ethnicity data, we supplemented missing ethnicity values with data from the Secondary Uses Service (SUS).

```{r echo=FALSE}
ethnicity_table <- data.frame(
  Code = c(1, 2, 3, 4, 5),
  Ethnicity = c(
    "White",
    "Mixed",
    "Asian or Asian British",
    "Black or Black British",
    "Chinese or Other Ethnic Groups"
  )
)

# ethnicity_table %>%
#   gt() %>%
#   tab_header(
#     title = "Table 2. Ethnic Group Codes",
#     subtitle = "Codes representing different ethnic groups in the study"
#   ) %>%
#   cols_label(
#     Code = "Code",
#     `Ethnicity` = "Ethnic Group"
#   ) %>%
#   tab_options(
#     table.font.size = "medium",
#     heading.title.font.size = "large",
#     heading.subtitle.font.size = "small"
#   )

```

# Results

### Total population

```{r, message=FALSE, warning=FALSE, fig.height=3, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_service") %>%
  filter(is.na(group_by))

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = NULL,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Consultations",
  y_label = "Number of codes for FP consultations",
)
```

```{r, message=FALSE, warning=FALSE, fig.height=10, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(is.na(group_by))

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Conditions",
  y_label = "Number of codes for PF conditions",
)
```

### Breakdown by age

```{r, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Age band")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = age_band,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Consultations",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = gradient_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Age band")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = age_band,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Consultations per 1000 people",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = gradient_palette)
```

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Age band")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = age_band,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Conditions",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = gradient_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Age band")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = age_band,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Conditions per 1000 people",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = gradient_palette)
```

### Breakdown by sex

```{r, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Sex")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = sex,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Consultations",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = sex_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Sex")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = sex,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Consultations per 1000 people",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = sex_palette)
```

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Sex")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = sex,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Conditions",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = sex_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Sex")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = sex,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Conditions per 1000 people",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = sex_palette)
```

### Breakdown by IMD

```{r, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "IMD")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = imd,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Consultations",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = gradient_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "IMD")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = imd,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Consultations per 1000 people",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = gradient_palette)
```

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "IMD")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = imd,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Conditions",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = gradient_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "IMD")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = imd,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Conditions per 1000 people",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = gradient_palette)
```

### Breakdown by region

```{r, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Region")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = region,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Consultations",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = region_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Region")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = region,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Consultations per 1000 people",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = region_palette)
```

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Region")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = region,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Conditions",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = region_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Region")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = region,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Conditions per 1000 people",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = region_palette)
```

### Breakdown by ethnicity

```{r, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Ethnicity")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = ethnicity,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Consultations",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = ethnicity_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Ethnicity")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = ethnicity,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Consultations per 1000 people",
  y_label = "Number of codes for FP consultations",
) + scale_color_manual(values = ethnicity_palette)
```

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Ethnicity")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = ethnicity,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Pharmacy First Conditions",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = ethnicity_palette)

# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Ethnicity")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = ratio,
  select_interval_date = interval_end,
  colour_var = ethnicity,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Rate of Pharmacy First Conditions per 1000 people",
  y_label = "Number of codes for PF conditions"
) + scale_color_manual(values = ethnicity_palette)
```
```{r, message=FALSE, warning=FALSE, echo = FALSE}
# Multiply by 0.4 to get 40% of data
df_bsa_validation <- df_bsa_validation %>%
  mutate(count_40pct = round(as.numeric(count * .4), digits = 0))

# OpenSAFELY data for clinical conditions into a tidy df
df_opensafely <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(interval_start >= as.Date("2024-02-01") & interval_start <= as.Date("2024-07-30")) %>%
  filter(is.na(group_by)) %>%
  select(date = interval_start, consultation_type = measure, count = numerator)

# Add a new column to each data frame to identify the source
df_opensafely <- df_opensafely %>%
  mutate(source = 'OS')
df_bsa_validation <- df_bsa_validation %>%
  mutate(source = 'BSA')

# Drop the original 'count' column from the BSA data to allow for easy consistent grouping by 'count'
df_validation_condition_counts <- df_bsa_validation %>%
  select(-count) %>%
  rename(count = count_40pct)
# Combining rows from OS and BSA dataframes
df_validation_condition_counts <- bind_rows(df_opensafely, df_validation_condition_counts)

# format both sources of data as MM-YYYY
df_validation_condition_counts <- df_validation_condition_counts %>%
  mutate(month = format(as.Date(date), "%m-%Y"))

# Pivot the data so that we get two sub columns per month for each source (OS and BSA)
df_pivoted <- df_validation_condition_counts %>%
  pivot_wider(names_from = c(month, source), values_from = count)

# Changing names to make column naming the same to ensure grouping
df_pivoted <- df_pivoted %>%
  mutate(
    consultation_type = recode(consultation_type,
    "sinusitis" = "Acute Sinusitis",
    "infected_insect_bites" = "Infected Insect Bite",
    "uncomplicated_uti" = "UTI",
    "acute_otitis_media" = "Acute Otitis Media",
    "acute_sore_throat" = "Acute Pharyngitis",
    "shingles" = "Herpes Zoster",
    "impetigo" = "Impetigo",)

  )
# Removing date column as this will prevent grouping (date is already pivot columns)
df_pivoted <- df_pivoted %>%
  select(-date)

# Group by consultation type and summarise to get rid of NAs and multiple consultation_types of same name
df_pivoted <- df_pivoted %>%
  group_by(consultation_type) %>%
  summarise(across(everything(), sum, na.rm = TRUE), .groups = "drop")

# Now create the gt table
tab_pf_conditions_validation <- df_pivoted %>%
  gt() %>%
  tab_header(
    title = "Validation Data of Pharmacy First Clinical Condition Counts",
    subtitle = "Timeframe: 1st Feb 2024 to 31st July 2024"
  ) %>%
  cols_label(
    consultation_type = "Clinical Condition",
    `02-2024_OS` = "OS",
    `02-2024_BSA` = "BSA",
    `03-2024_OS` = "OS",
    `03-2024_BSA` = "BSA",
    `04-2024_OS` = "OS",
    `04-2024_BSA` = "BSA",
    `05-2024_OS` = "OS",
    `05-2024_BSA` = "BSA",
    `06-2024_OS` = "OS",
    `06-2024_BSA` = "BSA",
    `07-2024_OS` = "OS",
    `07-2024_BSA` = "BSA"
  ) %>%
  tab_spanner(
    label = "February 2024",
    columns = c(`02-2024_OS`, `02-2024_BSA`)
  ) %>%
  tab_spanner(
    label = "March 2024",
    columns = c(`03-2024_OS`, `03-2024_BSA`)
  ) %>%
  tab_spanner(
    label = "April 2024",
    columns = c(`04-2024_OS`, `04-2024_BSA`)
  ) %>%
  tab_spanner(
    label = "May 2024",
    columns = c(`05-2024_OS`, `05-2024_BSA`)
  ) %>%
  tab_spanner(
    label = "June 2024",
    columns = c(`06-2024_OS`, `06-2024_BSA`)
  ) %>%
  tab_spanner(
    label = "July 2024",
    columns = c(`07-2024_OS`, `07-2024_BSA`)
  ) %>%
  tab_footnote(
    footnote = "OS - OpenSAFELY data, BSA - Validation data (NHS BSA)"
  ) %>%
  fmt_number(
    columns = everything(),
    decimals = 0
  )

tab_pf_conditions_validation
```

```{r, message=FALSE, warning=FALSE, echo = FALSE, fig.width=8}
df_long <- df_pivoted %>% pivot_longer(cols=c('02-2024_OS','02-2024_BSA','03-2024_OS','03-2024_BSA','04-2024_OS','04-2024_BSA','05-2024_OS','05-2024_BSA','06-2024_OS','06-2024_BSA','07-2024_OS','07-2024_BSA'),
  names_to=c('month', 'source'),
  names_sep = "_",
  values_to='count')
# Changing format of date to use label_date_short to keep dates consistent for figures
df_long$month <- as.Date(paste0("01-", df_long$month), format = "%d-%m-%Y")

# Line graph comparing clinical condition counts of BSA and OS data
validation_total_counts_figure <- ggplot(df_long, aes(x = month, y = count, color = consultation_type, group = consultation_type)) +
  geom_point() +
  geom_line(size = 0.5) +
  facet_wrap(~ source, scales = "free_y") +
  labs(title = "Clinical Conditions Count by Month (NHS BSA vs OpenSAFELY Data)",
       x = "Month", y = "Count", color = "Clinical Condition") +
  theme(
    plot.title = element_text(hjust = 0.5)) +
  scale_x_date(
      labels = scales::label_date_short()
  )

validation_total_counts_figure
```

```{r, message=FALSE, warning=FALSE, echo = FALSE, fig.width=8}
# Line graph comparing clinical condition counts of BSA and OS data
df_descriptive_stats <- df_descriptive_stats %>%
  mutate(
    measure = recode(measure,
    "pf_with_pfmed" = "PF Med",
    "pf_with_pfcondition" = "PF Condition",
    "pf_with_pfmed_and_pfcondition" = "PF Med & PF Condition",
    ))

descriptive_stats_figure <- ggplot(df_descriptive_stats, aes(x = interval_start, y = ratio, color = measure, group = measure)) +
  geom_point() +
  geom_line(size = 0.5) +
  # facet_wrap(~ measure, scales = "free_y") +
  labs(title = "Breakdown of PF consultations with linked PF conditions and medications",
      color = "PF consultation with:") +
  theme(
    plot.title = element_text(hjust = 0.5)) +
  scale_x_date(
      labels = scales::label_date_short()
  ) +
  scale_y_continuous(labels = scales::percent,
  limits = c(0,1)) + 
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank())

descriptive_stats_figure

```

# References