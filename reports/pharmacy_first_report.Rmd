---
title: "Pharmacy First"
output:
  html_document:
    toc: true
    toc_depth: 4
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(here)
library(readr)
library(gt)
```

```{r load-data, message=FALSE, warning=FALSE}
# Load plotting function
source(here::here("lib", "functions", "function_tidy_measures.R"))
source(here::here("lib", "functions", "function_plot_measures.R"))

# Load data based on environment
if (Sys.getenv("OPENSAFELY_BACKEND") != "") {
  # Load data from generate_pf_measures action
  df_measures <- readr::read_csv(
    here::here("output", "measures", "pf_codes_conditions_measures.csv")
  )
} else {
  # Load data from released_output directory
  df_measures <- readr::read_csv(
    here::here("released_output", "measures", "pf_codes_conditions_measures.csv")
  )
}

# Define dictionaries with tidy names and mappings for measures
pf_measures_name_dict <- list(
  consultation_service = "Consultation Service",
  pharmacy_first_service = "Pharmacy First Service",
  combined_pf_service = "Pharmacy First Services",
  acute_otitis_media = "Acute Otitis Media",
  herpes_zoster = "Herpes Zoster",
  acute_sinusitis = "Acute Sinusitis",
  impetigo = "Impetigo",
  infected_insect_bite = "Infected Insect Bite",
  acute_pharyngitis = "Acute Pharyngitis",
  uncomplicated_urinary_tract_infection = "UTI"
)

pf_measures_name_mapping <- list(
  consultation_service = "clinical_service",
  pharmacy_first_service = "clinical_service",
  combined_pf_service = "pharmacy_first_services",
  acute_otitis_media = "clinical_condition",
  herpes_zoster = "clinical_condition",
  acute_sinusitis = "clinical_condition",
  impetigo = "clinical_condition",
  infected_insect_bite = "clinical_condition",
  acute_pharyngitis = "clinical_condition",
  uncomplicated_urinary_tract_infection = "clinical_condition"
)

pf_measures_groupby_dict <- list(
  age_band = "Age band",
  sex = "Sex",
  imd = "IMD",
  region = "Region",
  ethnicity = "Ethnicity"
)

df_measures <- tidy_measures(
  data = df_measures,
  pf_measures_name_dict = pf_measures_name_dict,
  pf_measures_name_mapping = pf_measures_name_mapping,
  pf_measures_groupby_dict = pf_measures_groupby_dict
)

df_measures$ethnicity <- factor(
  df_measures$ethnicity,
  levels = c(
    "White", "Mixed", "Asian or Asian British",
    "Black or Black British", "Chinese or Other Ethnic Groups",
    "Missing"
  ),
  ordered = TRUE
)

df_measures$age_band <- factor(
  df_measures$age_band,
  levels = c(
    "0-19", "20-39", "40-59",
    "60-79", "80+",
    "Missing"
  ),
  ordered = TRUE
)

df_measures$region <- factor(
  df_measures$region,
  levels = c(
    "East", "East Midlands", "London",
    "North East", "North West", "South East",
    "South West", "West Midlands", "Yorkshire and The Humber",
    "Missing"
  ),
  ordered = TRUE
)

df_measures <- df_measures %>%
  mutate(sex = factor(sex, levels = c("female", "male"), labels = c("Female", "Male")))

df_measures$age_band[is.na(df_measures$age_band)] <- "Missing"  

gradient_palette <- c("#001F4D", "#0056B3", "#007BFF", "#66B3E2", "#A4D8E1", "grey")
region_palette <- c("red", "navy", "#018701", "#ffa600ca", "purple", "brown", "#f4a5b2", "cyan", "green", "grey")
ethnicity_palette <- c("#42db0188", "#0056B3", "#ff0000c2", "#a52a2a5a", "purple", "grey")
sex_palette <- c("red", "blue")
```

# Background

Add background here.

# Methods

This study utilised data from OpenSAFELY-TPP, which covers approximately 40% of the population of England. 
For a detailed description of the representativeness of this sample, please refer to our manuscript [here](https://wellcomeopenresearch.org/articles/7-191/v1).

Between 1st November 2023 and 1st September 2024, we identified individuals aged between 0 and 120 years who were registered at a TPP practice each month across the study period. 
From this cohort, we counted the number of patients with at least one SNOMED CT code indicating a consultation using the Pharmacy First Service. 
Patients with more than one instance of the same clinical code within a month were counted only once.

In addition to counts, we calculated rates by dividing the number of consultations by the total included study population and multiplying by 1,000, thereby obtaining a rate per 1,000 registered patients. 
Counts of â‰¤7 were redacted, and all figures were rounded to the nearest 5 to avoid potential re-identification of individuals. Rates were calculated using these rounded counts.

Our study relied on the correct entry of relevant Pharmacy First codes in patients' GP records. 
The Pharmacy First service uses [GP Connect - Update Record](https://digital.nhs.uk/services/gp-connect/gp-connect-in-your-organisation/gp-connect-update-record) to update a patient's GP record with consultation information from community pharmacies. 
Following the launch of the Pharmacy First service, there has been a [Gradual roll-out of GP Connect - Update Record](https://cpe.org.uk/our-news/gp-connect-update-record-rollout-and-flow-of-information/) across approved community pharmacy IT system suppliers.

### Codelists

To investigate Pharmacy First usage and the demographics of patients accessing the service, we used a variety of codelists to identify trends in Pharmacy First utilisation, including breakdowns by clinical condition and patient demographics.

#### Pharmacy First Event Codes

The following two SNOMED codes were used interchangeably to identify consultations classified as 'Pharmacy First consultations':

```{r echo=FALSE}

# Create pharmacy first service codes dataframe
pharmacy_first_table <- data.frame(
  codelist = c(
    "Community Pharmacist (CP) Consultation Service for minor illness (procedure)",
    "Pharmacy First service (qualifier value)"
  ),
  code = c(
    "1577041000000109",
    "983341000000102"
  )
)

# Create pharmacy first service codes table
pharmacy_first_table %>%
  gt() %>%
  tab_header(
    title = "Table 1. Pharmacy First Codes",
    subtitle = "Codelist descriptions and their respective SNOMED codes"
  ) %>%
  cols_label(
    codelist = "Codelist Description",
    code = "SNOMED Code"
  ) %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large",
    heading.subtitle.font.size = "small"
  )
```


We analysed trends in the usage of the Pharmacy First service by breaking down observations by various demographics, including age, sex, Index of Multiple Deprivation (IMD), region, and ethnicity.


#### Ethnicity Codelist

To assess service utilisation by ethnicity, we used the [ethnicity codelist](https://www.opencodelists.org/codelist/opensafely/ethnicity-snomed-0removed/2e641f61/). 
This involved matching ethnicity SNOMED codes recorded within the clinical events dataset with their corresponding ethnicity in the codelist. 
To ensure comprehensive ethnicity data, we supplemented missing primary care ethnicity values with data from the Secondary Uses Service (SUS).

```{r echo=FALSE}
ethnicity_table <- data.frame(
  Code = c(1, 2, 3, 4, 5),
  Ethnicity = c(
    "White",
    "Mixed",
    "Asian or Asian British",
    "Black or Black British",
    "Chinese or Other Ethnic Groups"
  )
)

# ethnicity_table %>%
#   gt() %>%
#   tab_header(
#     title = "Table 2. Ethnic Group Codes",
#     subtitle = "Codes representing different ethnic groups in the study"
#   ) %>%
#   cols_label(
#     Code = "Code",
#     `Ethnicity` = "Ethnic Group"
#   ) %>%
#   tab_options(
#     table.font.size = "medium",
#     heading.title.font.size = "large",
#     heading.subtitle.font.size = "small"
#   )

```
#### Pharmacy First Clinical Pathways Codes

We utilised the Pharmacy First [clinical pathways codelist](https://www.opencodelists.org/codelist/opensafely/pharmacy-first-clinical-pathway-conditions/7ec97762/#full-list) to categorise clinical events related to Pharmacy First services based on specific clinical pathways. 

```{r echo=FALSE, message=FALSE}

clinical_codes_table <- data.frame(
  condition = c(
    "Acute otitis media",
    "Herpes zoster",
    "Acute sinusitis",
    "Impetigo",
    "Infected insect bite",
    "Acute pharyngitis",
    "Uncomplicated urinary tract infection"
  ),
  code = c(
    "3110003",
    "4740000",
    "15805002",
    "48277006",
    "262550002",
    "363746003",
    "1090711000000102"
  )
)

# clinical_codes_table %>%
#   gt() %>%
#   tab_header(
#     title = "Table 3. Clinical Pathway Codes",
#     subtitle = "Clinical conditions and their corresponding SNOMED codes"
#   ) %>%
#   cols_label(
#     condition = "Clinical Condition",
#     code = "SNOMED Code"
#   ) %>%
#   tab_options(
#     table.font.size = "medium",
#     heading.title.font.size = "large",
#     heading.subtitle.font.size = "small"
#   )
```

#### Pregnancy Codelist

Following the breakdown of Pharmacy First usage by counts of clinical condition, we calculated rates to determine the proportion of patients with a diagnosis of a Pharmacy First-specific clinical condition, relative to the eligible patient population. 
The [pregnancy codelist](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/preg_cod/20200812/#full-list) was used to identify patients who were pregnant during the sample month, helping determine eligibility for different Pharmacy First conditions.

### Population

The eligible patient population for each clinical condition associated with Pharmacy First is detailed in the table below:

```{r echo=FALSE, message=FALSE}
# Create clinical pathways dataframe
clinical_pathways_table <- data.frame(
  Condition = c(
    "Uncomplicated Urinary Tract Infection",
    "Shingles",
    "Impetigo",
    "Infected Insect Bites",
    "Acute Sore Throat",
    "Acute Sinusitis",
    "Acute Otitis Media"
  ),
  Age = c(
    "16 to 64 years",
    "18 years and over",
    "1 year and over",
    "1 year and over",
    "5 years and over",
    "12 years and over",
    "1 to 17 years"
  ),
  Sex = c(
    "Female",
    "Any",
    "Any",
    "Any",
    "Any",
    "Any",
    "Any"
  ),
  Exclusions = c(
    "Pregnant individuals, urinary catheter, recurrent UTI (2 episodes in last 6 months, or 3 episodes in last 12 months)",
    "Pregnant individuals",
    "Bullous impetigo, recurrent impetigo (2 or more episodes in the same year), pregnant individuals under 16 years",
    "Pregnant individuals under 16 years",
    "Pregnant individuals under 16 years",
    "Immunosuppressed individuals, chronic sinusitis (symptoms lasting more than 12 weeks), pregnant individuals under 16 years",
    "Recurrent acute otitis media (3 or more episodes in 6 months or four or more episodes in 12 months), pregnant individuals under 16 years"
  )
)

# Create clinical pathways table
clinical_pathways_table %>%
  gt() %>%
  tab_header(
    title = "Table 2. Clinical Pathways",
    subtitle = "Inclusion and exclusion criteria for clinical pathway/conditions"
  ) %>%
  cols_label(
    Condition = "Condition",
    Age = "Age Range",
    Sex = "Sex",
    Exclusions = "Exclusions"
  ) %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large",
    heading.subtitle.font.size = "small"
  ) %>%
  cols_width(
    Condition ~ px(200),
    Age ~ px(100),
    Sex ~ px(75),
    Exclusions ~ px(300)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  )

```

We excluded pregnant individuals for specific conditions where pregnancy made inclusion inappropriate, such as urinary tract infections (UTI) and shingles. 
Additionally, pregnant individuals under 16 years were excluded for conditions like impetigo, infected insect bites, sore throat, sinusitis, and otitis. 
Patients with recurrent diagnoses of the studied conditions were also excluded to focus on first-time or singular episodes, such as for UTI, impetigo and acute otitis media. 
Furthermore, exclusions were applied based on age ranges and sex, in alignment with the eligibility criteria defined for each clinical condition. 
These categories represented the most substantial sources of exclusion, whereas other specific criteria were anticipated to yield minimal exclusions.

# Results

## Clinical Services

### Total population

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_service") %>%
  filter(is.na(group_by))

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = NULL,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical service per month",
  y_label = "Number of codes for consultations",
) 
```

### Breakdown by age

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Age band")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = age_band,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical service by age band per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = gradient_palette)

```

### Breakdown by sex

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Sex")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = sex,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical service by sex per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = sex_palette)
```

### Breakdown by IMD

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "IMD")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = imd,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical service by IMD per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = gradient_palette)
```

### Breakdown by region

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Region")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = region,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical service by region per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = region_palette)
```

### Breakdown by ethnicity

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "pharmacy_first_services") %>%
  filter(group_by == "Ethnicity")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = ethnicity,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical service by ethnicity per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = ethnicity_palette)
```

## Clinical Condition

This section focuses on the clinical conditions within the Clinical Pathways element of that Pharmacy First service:  
Here we show the number of consultations for each of the Pharmacy First Clinical Pathways Clinical Conditions.

### Total population

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(is.na(group_by))

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical condition per month",
  y_label = "Number of codes for consultations",
)
```

### Breakdown by age

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Age band")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = age_band,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical condition by age band per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = gradient_palette)
```

### Breakdown by sex

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Sex")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = sex,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical condition by sex per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = sex_palette)
```

### Breakdown by IMD

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "IMD")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = imd,
  guide_nrow = 1,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical condition by IMD per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = gradient_palette)
```

### Breakdown by region

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Region")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = region,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical condition by region per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = region_palette)
```

### Clinical Conditions by ethnicity

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# Select measures and breakdown
df_measures_selected <- df_measures %>%
  filter(measure_desc == "clinical_condition") %>%
  filter(group_by == "Ethnicity")

# Create visualisation
plot_measures(
  df_measures_selected,
  select_value = numerator,
  select_interval_date = interval_end,
  colour_var = ethnicity,
  guide_nrow = 2,
  facet_wrap = TRUE,
  facet_var = measure,
  title = "Number of consultations for each clinical condition by ethnicity per month",
  y_label = "Number of codes for consultations",
) + scale_color_manual(values = ethnicity_palette)
```
