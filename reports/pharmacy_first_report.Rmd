---
title: "Pharmacy First"
output:
  html_document:
    toc: true
    toc_depth: 4
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(here)
library(readr)
```

```{r load-data, message=FALSE, warning=FALSE}
# Load plotting function
source(here::here("lib", "functions", "function_plot_measures.R"))
# Load data
df_measures <- readr::read_csv(
  here::here("output", "measures", "pf_codes_conditions_measures.csv")
)
```

```{r setup-dicts, message=FALSE, warning=FALSE}
# Define the custom labels for clinical conditions
pf_clinical_condition_dict <- c(
  "count_acute_otitis_media" = "Acute Otitis Media",
  "count_herpes_zoster" = "Herpes Zoster",
  "count_acute_sinusitis" = "Acute Sinusitis",
  "count_impetigo" = "Impetigo",
  "count_infected_insect_bite" = "Infected Insect Bite",
  "count_acute_pharyngitis" = "Acute Pharyngitis",
  "count_uncomplicated_urinary_tract_infection" = "UTI"
)

# Define the custom labels for clinical conditions by age
pf_clinical_condition_dict_by_age <- c(
  "count_acute_otitis_media_by_age" = "Acute Otitis Media",
  "count_herpes_zoster_by_age" = "Herpes Zoster",
  "count_acute_sinusitis_by_age" = "Acute Sinusitis",
  "count_impetigo_by_age" = "Impetigo",
  "count_infected_insect_bite_by_age" = "Infected Insect Bite",
  "count_acute_pharyngitis_by_age" = "Acute Pharyngitis",
  "count_uncomplicated_urinary_tract_infection_by_age" = "UTI"
)

# Define the custom labels for clinical conditions by sex
pf_clinical_condition_dict_by_sex <- c(
  "count_acute_otitis_media_by_sex" = "Acute Otitis Media",
  "count_herpes_zoster_by_sex" = "Herpes Zoster",
  "count_acute_sinusitis_by_sex" = "Acute Sinusitis",
  "count_impetigo_by_sex" = "Impetigo",
  "count_infected_insect_bite_by_sex" = "Infected Insect Bite",
  "count_acute_pharyngitis_by_sex" = "Acute Pharyngitis",
  "count_uncomplicated_urinary_tract_infection_by_sex" = "UTI"
)

# Define the custom labels for clinical conditions by IMD
pf_clinical_condition_dict_by_imd <- c(
  "count_acute_otitis_media_by_imd" = "Acute Otitis Media",
  "count_herpes_zoster_by_imd" = "Herpes Zoster",
  "count_acute_sinusitis_by_imd" = "Acute Sinusitis",
  "count_impetigo_by_imd" = "Impetigo",
  "count_infected_insect_bite_by_imd" = "Infected Insect Bite",
  "count_acute_pharyngitis_by_imd" = "Acute Pharyngitis",
  "count_uncomplicated_urinary_tract_infection_by_imd" = "UTI"
)

# Define the custom labels for clinical conditions by region
pf_clinical_condition_dict_by_region <- c(
  "count_acute_otitis_media_by_region" = "Acute Otitis Media",
  "count_herpes_zoster_by_region" = "Herpes Zoster",
  "count_acute_sinusitis_by_region" = "Acute Sinusitis",
  "count_impetigo_by_region" = "Impetigo",
  "count_infected_insect_bite_by_region" = "Infected Insect Bite",
  "count_acute_pharyngitis_by_region" = "Acute Pharyngitis",
  "count_uncomplicated_urinary_tract_infection_by_region" = "UTI"
)

# Define the custom labels for clinical services
pf_clinical_service_dict <- c(
  "count_blood_pressure_service" = "Blood Pressure Service",
  "count_contraception_service" = "Contraception Service",
  "count_consultation_service" = "Consultation Service",
  "count_pharmacy_first_service" = "Pharmacy First Service"
)

# Define the custom labels for clinical services by age
pf_clinical_service_dict_by_age <- c(
  "count_blood_pressure_service_by_age" = "Blood Pressure Service",
  "count_contraception_service_by_age" = "Contraception Service",
  "count_consultation_service_by_age" = "Consultation Service",
  "count_pharmacy_first_service_by_age" = "Pharmacy First Service"
)

# Define the custom labels for clinical services by sex
pf_clinical_service_dict_by_sex <- c(
  "count_blood_pressure_service_by_sex" = "Blood Pressure Service",
  "count_contraception_service_by_sex" = "Contraception Service",
  "count_consultation_service_by_sex" = "Consultation Service",
  "count_pharmacy_first_service_by_sex" = "Pharmacy First Service"
)

# Define the custom labels for clinical services by IMD
pf_clinical_service_dict_by_imd <- c(
  "count_blood_pressure_service_by_imd" = "Blood Pressure Service",
  "count_contraception_service_by_imd" = "Contraception Service",
  "count_consultation_service_by_imd" = "Consultation Service",
  "count_pharmacy_first_service_by_imd" = "Pharmacy First Service"
)

# Define the custom labels for clinical services by region
pf_clinical_service_dict_by_region <- c(
  "count_blood_pressure_service_by_region" = "Blood Pressure Service",
  "count_contraception_service_by_region" = "Contraception Service",
  "count_consultation_service_by_region" = "Consultation Service",
  "count_pharmacy_first_service_by_region" = "Pharmacy First Service"
)
```

# Background

Add background here.

# Methods

This study used data from OpenSAFELY-TPP, which covers 40% of the population of England. For a description of the representativeness of this sample, please see our manuscript [here](https://wellcomeopenresearch.org/articles/7-191/v1).
Individuals were included if they were alive and registered at a TPP practice each month, across the study period.
Patients were excluded if their listed age was not between 0 and 120 years.
Counts represent patients with at least one clinical code of relevance in that month.
Patients with more than one of the same clinical code in a month were only counted once. Rates divide the count by the included study population and multiply by 1,000 to achieve a rate per 1,000 registered patients.
Counts <=7 have been redacted and all numbers rounded to the nearest 5 to avoid potential re-identification of individuals. The rates displayed were computed with these rounded counts.
Our data relies on a relevant Pharmacy First code being added to a patient's GP record.
The Pharmacy First service relies on [GP Connect - Update Record](https://digital.nhs.uk/services/gp-connect/gp-connect-in-your-organisation/gp-connect-update-record) to update a patient's GP record with consultation information from the community pharmacy.
Following the launch of the Pharmacy First service, there has been a [Gradual roll-out of GP Connect - Update Record](https://cpe.org.uk/our-news/gp-connect-update-record-rollout-and-flow-of-information/) across the approved community pharmacy IT system suppliers.

Links to the codelist for each analysis can be found beneath the relevant section.

# Results

## Clinical Services

```{r, message=FALSE, warning=FALSE}
plot_measures(df_measures,
  title = "Number of consultations for each clinical service per month",
  measure_names = names(pf_clinical_service_dict),
  custom_labels = pf_clinical_service_dict,
  y_label = "Number of codes for consultations",
)
```

### Clinical Services by Age

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical service by age per month",
  measure_names = names(pf_clinical_service_dict_by_age),
  custom_labels = pf_clinical_service_dict_by_age,
  y_label = "Number of codes for consultations",
  facet_var = "age_band",
  rotate_x_labels = TRUE
)
```

### Clinical Services by Sex

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical service by sex per month",
  measure_names = names(pf_clinical_service_dict_by_sex),
  custom_labels = pf_clinical_service_dict_by_sex,
  y_label = "Number of codes for consultations",
  facet_var = "sex",
  rotate_x_labels = TRUE
)
```

### Clinical Services by IMD

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical service by IMD per month",
  measure_names = names(pf_clinical_service_dict_by_imd),
  custom_labels = pf_clinical_service_dict_by_imd,
  y_label = "Number of codes for consultations",
  facet_var = "imd",
  rotate_x_labels = TRUE
)
```

### Clinical Services by Region

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical service by region per month",
  measure_names = names(pf_clinical_service_dict_by_region),
  custom_labels = pf_clinical_service_dict_by_region,
  y_label = "Number of codes for consultations",
  facet_var = "region",
  rotate_x_labels = TRUE
)
```

## Clinical Pathways

This section focuses on the Clinical Pathways element of the Pharmacy First service.  

## Clinical Condition

This section focuses on the clinical conditions within the Clinical Pathways element of that Pharmacy First service:  
Here we show the number of consultations for each of the Pharmacy First Clinical Pathways Clinical Conditions.

```{r, message=FALSE, warning=FALSE}
plot_measures(df_measures,
  title = "Number of consultations for each clinical condition per month",
  measure_names = names(pf_clinical_condition_dict),
  custom_labels = pf_clinical_condition_dict,
  y_label = "Number of codes for consultations",
)
```

### Clinical Conditions by Age

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical condition by age per month",
  measure_names = names(pf_clinical_condition_dict_by_age),
  custom_labels = pf_clinical_condition_dict_by_age,
  y_label = "Number of codes for consultations",
  facet_var = "age_band",
  rotate_x_labels = TRUE
)
```

### Clinical Conditions by Sex

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical condition by sex per month",
  measure_names = names(pf_clinical_condition_dict_by_sex),
  custom_labels = pf_clinical_condition_dict_by_sex,
  y_label = "Number of codes for consultations",
  facet_var = "sex",
  rotate_x_labels = TRUE
)
```

### Clinical Conditions by IMD

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical condition by IMD per month",
  measure_names = names(pf_clinical_condition_dict_by_imd),
  custom_labels = pf_clinical_condition_dict_by_imd,
  y_label = "Number of codes for consultations",
  facet_var = "imd",
  rotate_x_labels = TRUE
)
```

### Clinical Conditions by Region

```{r, message=FALSE, warning=FALSE}

plot_measures(df_measures,
  title = "Number of consultations for each clinical condition by region per month",
  measure_names = names(pf_clinical_condition_dict_by_region),
  custom_labels = pf_clinical_condition_dict_by_region,
  y_label = "Number of codes for consultations",
  facet_var = "region",
  rotate_x_labels = TRUE
)
```